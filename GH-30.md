# GH-30: Case-Insensitive Tags with Canonical Case Display

## Current State Analysis

The system currently has **dual tag systems**:
1. **Legacy**: Character `tags: string[]` field (line 62 in character.entity.ts)
2. **New**: Relational `tags_rel: CharacterTag[]` field (line 84) connecting to proper Tag entities

**Current Issues**:
- Tags are stored in lowercase and displayed in lowercase
- Users report case-sensitive behavior (e.g., "Fantasy", "fantasy", "FANTASY" treated as separate tags)
- Users expect proper casing display while maintaining case-insensitive matching

## Solution Plan

### **Phase 1: Database Schema Enhancement**
- Add `displayName` field to the Tag model for canonical case display (not-null)
- Keep existing `name` field for case-insensitive matching (lowercase)
- Create migration to backfill existing tags: set `displayName = name` (keep current values as-is)
- Set `displayName` as not-null after backfill is complete

### **Phase 2: Backend Updates**
- Update tag creation logic in characters/images/media services:
  - Mutations continue to accept `tags: string[]` (no frontend changes needed)
  - For each tag string: normalize to lowercase for lookup (`name` field)
  - If tag exists (case-insensitive): use existing tag entity
  - If tag doesn't exist: create new tag with `name = lowercase(input)`, `displayName = input`
- Modify GraphQL Tag entity to include `displayName` field
- Update tags.service.ts to return `displayName` in search results
- Ensure all tag operations remain case-insensitive for matching on `name` field

### **Phase 3: Frontend Updates**
- Frontend continues using `tags: string[]` for mutations (no GraphQL changes needed)
- Update TagInput component to display `displayName` from tag search results
- **Backend resolvers return properly cased tag strings**: When resolving `tags: string[]` fields, use `displayName` values instead of lowercase `name` values
- Frontend continues treating tags as opaque strings - no knowledge of internal Tag entities needed

### **Phase 4: Testing & Migration**
- Handle any legacy string array tags if still in use
- Consolidate case-variant duplicates during migration (merge "Fantasy"/"fantasy"/"FANTASY" → keep first one's displayName)
- Comprehensive testing of case-insensitive matching
- Type checking and regression tests

## Implementation Details

### Tag Creation Logic
```
When user submits tags: ["Fantasy", "magic", "Dragon"]:
1. For each string, normalize: ["fantasy", "magic", "dragon"]
2. For "Fantasy" → lookup tag with name="fantasy"
   - If exists: use existing tag entity (preserve existing displayName)
   - If new: create tag with name="fantasy", displayName="Fantasy"
3. Repeat for each tag string
4. Connect found/created tag entities to the character/image/media
```

### Migration Strategy
```sql
-- Step 1: Add displayName column as nullable
ALTER TABLE tags ADD COLUMN display_name VARCHAR(50);

-- Step 2: Backfill with current name values
UPDATE tags SET display_name = name;

-- Step 3: Make displayName not-null after backfill
ALTER TABLE tags ALTER COLUMN display_name SET NOT NULL;
```

## Key Benefits

1. **User Experience**: Tags display with user-entered casing (e.g., "Fantasy" not "fantasy")
2. **Data Integrity**: Prevents duplicate tags due to case differences
3. **Frontend Simplicity**: Tags remain opaque strings to frontend - no complex entity relationships
4. **Backward Compatibility**: Existing functionality preserved
5. **Intuitive Behavior**: First person to use a tag sets the canonical display format

## Files to Modify

- `packages/database/prisma/schema.prisma` - Add displayName field
- `apps/backend/src/shared/entities/tag.entity.ts` - Add displayName to GraphQL schema
- `apps/backend/src/characters/characters.service.ts` - Update tag creation logic
- `apps/backend/src/images/images.service.ts` - Update tag creation logic  
- `apps/backend/src/media/media.service.ts` - Update tag creation logic
- `apps/backend/src/tags/tags.service.ts` - Return displayName in responses
- `packages/ui/src/components/TagInput.tsx` - Display displayName
- Frontend tag display components - Use displayName for presentation